/* The FileLoader parses all textfiles and loads them into the game
 *    Edited. Will make more edits once updated txt files are uploaded.
 */

import java.io.*;
import java.util.*;

public class FileLoader
{
	private Map<Integer, Room> gameMap = new HashMap<>();
	private ArrayList<Item> itemAL = new ArrayList<>();
	private ArrayList<Puzzle> puzzleAL = new ArrayList<>();
	private ArrayList<Character> charAL = new ArrayList<>();
	private ArrayList<Player> playerAL = new ArrayList<>();

	public Map<Integer, Room> loadRooms(String fileName)
	{
		try(Scanner scan = new Scanner(new File(fileName)))
		{
			while(scan.hasNextLine())
			{
				String line = scan.nextLine().trim();
				try(Scanner scan2 = new Scanner(line))
				{
					scan2.useDelimiter("%");

					String roomID = scan2.next();
					String roomFloorID = scan2.next();
					String roomName = scan2.next();
					String roomDesc = scan2.next();
					String [] roomExits = scan2.next().split(",");

					Room room = new Room(roomID, roomFloorID, roomName, roomDesc);

					//add exits for each room
					room.addExit("north", Integer.parseInt(roomExits[0]));
					room.addExit("east", Integer.parseInt(roomExits[1]));
					room.addExit("south", Integer.parseInt(roomExits[2]));
					room.addExit("west", Integer.parseInt(roomExits[3]));

					//add rooms to game map
					gameMap.put(roomID, room);
				}

				catch(exception e)
				{
					System.out.println("Error parsing line: " + line);
					e.printStackTrace();
				}
			}
		}

		catch(FileNotFoundException fnfe)
		{
			System.out.println("Rooms file not found.");
			fnfe.printStackTrace();
		}

		return gameMap;
	}

	public ArrayList<Item> loadItems(String fileName)
	{
		try(Scanner scan = new Scanner(new File(fileName)))
		{
			while(scan.hasNextLine())
			{
				String line = scan.nextLine().trim();
				try(Scanner scan2 = new Scanner(line))
				{
					scan2.useDelimiter("%");

					String itemID = scan2.next();
					String itemName = scan2.next();
					String itemDesc = scan2.next();
					String itemType = scan2.next();
					int itemValue = scan2.nextInt();
					String itemRoomID = scan2.next();
					int maxStack = scan2.hasNextInt() ? scan2.nextInt() : 1;

					Item item;

					switch(itemType)
					{
						case "Weapon" ->
							item = new Weapon(itemID, itemName, itemDesc, itemValue);
						case "Consumable" ->
							item = new Consumable(itemID, itemName, itemDesc, itemValue, maxStack);
						case "Useable" ->
							item = new Useable(itemID, itemName, itemDesc, itemValue, maxStack);

						default ->
						{
							System.out.println("Unknown item type.");
							continue;
						}
					}

					String [] itemRoomIDs = itemRoomID.split(",");
					for(String entry : itemRoomIDs)
					{
						entry = entry.trim();
						String parts = entry.split(",");
						String roomID = parts.[0].trim();
						int quantity = (parts.length > 1) ? Integer.parseInt(parts[1]) : 1;
					
						Room room = gameMap.get(roomID);
						if(room != null)
						{
							Item itemCopy = item.clone();
							itemCopy.currentStack = quantity;
							room.addItem(itemCopy);
							itemAL.add(itemCopy);
						}

						else
						{
							System.out.println("Room " + roomID + 
								"not found for this item" + itemName);
						}
					}

					catch(Exception e)
					{
						System.out.println("Error parsing line: " + line);
						e.printStackTrace();
					}
				}
			}

			catch(FileNotFoundException fnfe)
			{
				System.out.println("Items file not found.");
				fnfe.printStackTrace();
			}

			return itemAL;
		}


		public ArrayList<Puzzle> loadPuzzles(String fileName)
		{
			try(Scanner scan = new Scanner(new File(fileName)))
			{
				while(scan.hasNextLine())
				{
					String line = scan.nextLine().trim();
					try(Scanner scan2 = new Scanner(line))
					{
						scan2.useDelimiter("%");

						String puzzleID = scan2.next();
						String name = scan2.next();
						String location = scan2.next();
						String description = scan2.next();
						String answer = scan2.next();
						int maxAttempts = scan2.nextInt();

						Puzzle puzzle = new Puzzle(puzzleID, name, location, description,
								answer, maxAttempts);

						puzzleAL.add(puzzle);

						Room room = gameMap.get(location);

						//room exists
						if(room != null)
						{
							room.setPuzzle(puzzle);
						}

						//room does not exist
						else
						{
							System.out.println("Room " + puzzleRoomID +
									" not found for puzzle" + puzzleID);
						}
					}

					catch(Exception e)
					{
						System.out.println("Error parsing line: " + line);
						e.printStackTrace();
					}
				}
			}

			catch(FileNotFoundException fnfe)
			{
				System.out.println("Puzzles file not found.");
				fnfe.printStackTrace();
			}

			return puzzleAL;
		}


		public ArrayList<Character> loadChars(String fileName)
		{
			try(Scanner scan = new Scanner(new File(fileName)))
			{
				while(scan.hasNextLine())
				{
					String line = scan.nextLine().trim();
					try(Scanner scan2 = new Scanner(line))
					{
						scan2.useDelimiter("%");

						String charID = scan2.next();
						String charName = scan2.next();
						String charDesc = scan2.next();
						String charType = scan2.next();
						int charRoomID = scan2.nextInt();

						Character char;

						switch(charType)
						{
							case "NPC" ->
								char = new NPC(charID, charName, charDesc);
							case "Monster" ->
								char = new Monster(charID, charName, charDesc);
							
							default ->
							{
								System.out.println("Unknown character type.");
								continue;
							}
						}

						charAL.add(char);

						Room room = gameMap.get(charRoomID);

						//room exists
						if(room != null)
						{
							room.setCharacter(char);
						}

						//room does not exist
						else
						{
							System.out.println("Room " + charRoomID +
									" not found for character" + charID);
						}
					}

					catch(Exception e)
					{
						System.out.println("Error parsing line: " + line);
						e.printStackTrace();
					}
				}
			}

			catch(FileNotFoundException fnfe)
			{
				System.out.println("Characters file not found.");
				fnfe.printStackTrace();
			}

			return charAL;
		}


		public ArrayList<Player> loadPlayers(String fileName)
		{
			try(Scanner scan = new Scanner(new File(fileName)))
			{
				while(scan.hasNextLine())
				{
					String line = scan.nextLine().trim();
					try(Scanner scan2 = new Scanner(line))
					{
						scan2.useDelimiter("%");

						String playerName = scan2.next();
						int playerHP = scan2.nextInt();
						int playerDamage = scan2.nextInt();

						Player player = new Player(playerName, playerHP, playerDamage);

						playerAL.add(player);
					}

					catch(Exception e)
					{
						System.out.println("Error parsing line: " + line);
						e.printStackTrace();
					}
				}
			}

			catch(FileNotFoundException fnfe)
			{
				System.out.println("Players file not found.");
				fnfe.printStackTrace();
			}

			return playerAL;
		}

		public Map<Integer, Room> getRoomMap() 
		{
			return gameMap;
		}

		public ArrayList<Item> getItemList() 
		{
			return itemAL;
		}

		public ArrayList<Puzzle> getPuzzleList() 
		{
			return puzzleAL;
		}

		public ArrayList<Character> getCharList() 
		{
			return charAL;
		}

		public ArrayList<Player> getPlayerList() 
		{
			return playerAL;
		}
	}
